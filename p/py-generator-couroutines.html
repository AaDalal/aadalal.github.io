<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.DrWrC8pZ.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.CSiO-_EV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BKjmoLrz.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/FR1t_9wV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/jQIVLDjP.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.950MbjmM.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B7wczw3A.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/KcOE5pfD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Ck1U9rAg.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.D7prmMXb.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/PXRjJVOa.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/3.DAXhhgOn.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B7Ff-sBd.js"><!--xod7dh--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><!----><title>Python Coroutines!?!? | aagam's blog</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><!--[--><!----><main><div style="[object Object]" class="full grid grid-cols-8 font-medium"><div class="col-span-8 md:col-span-2 p-4 border-2 flex flex-row justify-between items-center flex-shrink"><a class="font-bold text-xl" href="/">aadalal</a> <!--[!--><!--]--><!----></div> <div class="col-span-0 hidden md:col-span-6 py-4 px-2 border-y-2 border-r-2 md:grid grid-cols-16 gap-6 overflow-hidden whitespace-nowrap items-center justify-center"><div class="col-span-5 flex justify-end items-center flex-shrink gap-5"><!--[--><a href="/p/fast" class="opacity-75">Go fast!</a><a href="/p/consistent-hashing" class="opacity-75">Consistent Hashing</a><a href="/p/rendevous-hashing" class="opacity-75">Rendevous Hashing</a><!--]--></div> <div class="col-span-6 flex flex-row justify-between items-center flex-shrink-0 z-10"><a id="previous-post" href="/p/rendevous-hashing" aria-label="Previous post"><svg xmlns="http://www.w3.org/2000/svg" class="h-8" fill="currentColor" viewBox="144 64 224 384"><path d="M368 64L144 256l224 192V64z"></path></svg></a> <div class="shrink text-2xl font-junicode bg-white dark:bg-black">Python Coroutines!?!?</div> <a id="next-post" href="/p/PMing" aria-label="Next post"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-8 dark:text-white" viewBox="144 64 224 384"><path d="M144 448l224-192L144 64v384z"></path></svg></a></div> <div class="col-span-5 flex justify-start items-center flex-shrink gap-5"><!--[--><a href="/p/PMing" class="opacity-75">Lessons from Product Managing</a><a href="/p/einsum" class="opacity-75">Einsum</a><a href="/p/entropy" class="opacity-75">Entropy</a><a href="/p/_sudo" class="opacity-75">Try again with sudo: _sudo</a><a href="/p/competition-focus" class="opacity-75">Roku &amp; Competition</a><!--]--></div></div></div><!----> <div><article class="max-w-2xl mx-auto px-3 mt-4"><header><div class="italic opacity-75 mt-10 mb-5"><time>2023-06-11</time></div> <h1 class="text-8xl w-3/4 font-junicode mb-10">Python Coroutines!?!?</h1></header> <section class="prose dark:prose-invert prose-a:text-blue-600 dark:prose-a:text-blue-500 hover:prose-a:text-blue-900 hover:dark:prose-a:text-blue-800 dark:prose-pre:border-gray-900 dark:prose-pre:border"><!----><p>Python supports generators which allow you to <code>.send()</code> and recieve (via <code>next(...)</code>) values. They are kind of like channels since they don't block until you send or recieve.</p>
<p>In the code below, we use callbacks (called aperiodically in a separate thread) to send values to our channel. Simultaneously, we try to consume those values, which should be allowed because generators and our <code>coroutine</code> are non-blocking.</p>
<pre><code class="language-python">import time, threading

def channel(x="Hello"):
    while True:
        x = yield x

def make_coroutine(callback):
    def coroutine():
        callback()
        threading.Timer(1, coroutine).start()
    return coroutine

def make_callback():
    chan = channel()
    # prime the channel
    next(chan)

    def callback():
        print("Calling!")
        chan.send("Hello world!")
    
    return chan, callback

def main():
    chan, callback = make_callback()
    coroutine = make_coroutine(callback)
    coroutine()
    for i in chan:
        if i is not None:
            print(i)

if __name__ == "__main__":
    main()
</code></pre>
<p>And yet, this approach doesn't work as expected! One of three things happens:</p>
<ol>
<li><code>ValueError: generator already executing</code></li>
<li>only None values are output from the channel</li>
</ol>
<p>Why doesn't this work? email me if you have an answer.</p><!----></section></article></div><!----></main><!----><!--]--><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_t6cd1x = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.CSiO-_EV.js"),
						import("../_app/immutable/entry/app.950MbjmM.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data: [null,{type:"data",data:{post:{title:"Python Coroutines!?!?",date:"2023-06-11",slug:"py-generator-couroutines",content:"\u003Cp>Python supports generators which allow you to \u003Ccode>.send()\u003C/code> and recieve (via \u003Ccode>next(...)\u003C/code>) values. They are kind of like channels since they don't block until you send or recieve.\u003C/p>\n\u003Cp>In the code below, we use callbacks (called aperiodically in a separate thread) to send values to our channel. Simultaneously, we try to consume those values, which should be allowed because generators and our \u003Ccode>coroutine\u003C/code> are non-blocking.\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-python\">import time, threading\n\ndef channel(x=\"Hello\"):\n    while True:\n        x = yield x\n\ndef make_coroutine(callback):\n    def coroutine():\n        callback()\n        threading.Timer(1, coroutine).start()\n    return coroutine\n\ndef make_callback():\n    chan = channel()\n    # prime the channel\n    next(chan)\n\n    def callback():\n        print(\"Calling!\")\n        chan.send(\"Hello world!\")\n    \n    return chan, callback\n\ndef main():\n    chan, callback = make_callback()\n    coroutine = make_coroutine(callback)\n    coroutine()\n    for i in chan:\n        if i is not None:\n            print(i)\n\nif __name__ == \"__main__\":\n    main()\n\u003C/code>\u003C/pre>\n\u003Cp>And yet, this approach doesn't work as expected! One of three things happens:\u003C/p>\n\u003Col>\n\u003Cli>\u003Ccode>ValueError: generator already executing\u003C/code>\u003C/li>\n\u003Cli>only None values are output from the channel\u003C/li>\n\u003C/ol>\n\u003Cp>Why doesn't this work? email me if you have an answer.\u003C/p>",tags:"async,asyncio,python,coroutine,generator"},allPosts:[{title:"Go fast!",slug:"fast",date:"2024-01-01"},{title:"Consistent Hashing",slug:"consistent-hashing",date:"2023-10-26"},{title:"Rendevous Hashing",slug:"rendevous-hashing",date:"2023-10-26"},{title:"Python Coroutines!?!?",slug:"py-generator-couroutines",date:"2023-06-11"},{title:"Lessons from Product Managing",slug:"PMing",date:"2023-06-01"},{title:"Einsum",slug:"einsum",date:"2022-03-14"},{title:"Entropy",slug:"entropy",date:"2021-12-28"},{title:"Try again with sudo: _sudo",slug:"_sudo",date:"2021-11-11"},{title:"Roku & Competition",slug:"competition-focus",date:"2021-11-11"}]},uses:{params:["slug"]}}],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
